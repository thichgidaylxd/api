<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Quáº£n lÃ½ bÃ n - Realtime</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial; padding: 10px; }
        input, button, select { margin: 6px; }
        li { margin: 8px 0; }
        .section { margin-bottom: 30px; }
    </style>
</head>
<body>

<h2>ğŸª‘ Quáº£n lÃ½ bÃ n realtime</h2>
<button onclick="connect()">ğŸ”Œ Káº¿t ná»‘i WebSocket</button>
<button onclick="disconnect()">âŒ Ngáº¯t káº¿t ná»‘i</button>

<div class="section">
    <h3>â• ThÃªm bÃ n</h3>
    <input type="text" id="tableName" placeholder="TÃªn bÃ n" />
    <select id="tableTypeSelect">
        <option disabled selected>-- Chá»n loáº¡i bÃ n --</option>
    </select>
    <button onclick="addTable()">ThÃªm bÃ n</button>
</div>

<div class="section">
    <h3>â• ThÃªm loáº¡i bÃ n</h3>
    <input type="text" id="tableTypeName" placeholder="TÃªn loáº¡i bÃ n" />
    <button onclick="addTableType()">ThÃªm loáº¡i bÃ n</button>
</div>

<div class="section">
    <h3>ğŸ“‹ Danh sÃ¡ch bÃ n</h3>
    <ul id="tableList"></ul>
</div>

<div class="section">
    <h3>ğŸ“¦ Danh sÃ¡ch loáº¡i bÃ n</h3>
    <ul id="tableTypeList"></ul>
</div>

<div class="section">
    <h3>ğŸ½ï¸ Danh sÃ¡ch mÃ³n nhÃ  hÃ ng</h3>
    <ul id="dishList"></ul>
</div>

<div class="section">
    <h3>ğŸ§¾ MÃ³n Ä‘Ã£ gá»i trong bÃ n</h3>
    <input type="text" id="selectedTableId" placeholder="ID bÃ n cáº§n xem mÃ³n" />
    <button onclick="loadOrderItems()">ğŸ“¥ Táº£i mÃ³n trong bÃ n</button>
    <ul id="orderItemList"></ul>

</div>

<script>
    const BASE_URL = "http://localhost:8081/restaurant/api";
    let stompClient = null;
    let tables = [];
    let tableTypes = [];
    let orderItems = [];
    function connect() {
      const socket = new SockJS(`${BASE_URL}/ws/tables`);
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log("âœ… Káº¿t ná»‘i WebSocket:", frame);

        stompClient.subscribe("/topic/table-added", msg => {
          const table = JSON.parse(msg.body);
          tables.push(table);
          renderTables();
        });

        stompClient.subscribe("/topic/table-deleted", msg => {
          const table = JSON.parse(msg.body);
          tables = tables.filter(t => t.id !== table.id);
          renderTables();
        });

        stompClient.subscribe("/topic/tabletype-added", msg => {
          const type = JSON.parse(msg.body);
          tableTypes.push(type);
          renderTableTypes();
        });

        stompClient.subscribe("/topic/tabletype-deleted", msg => {
          const type = JSON.parse(msg.body);
          tableTypes = tableTypes.filter(t => t.id !== type.id);
          renderTableTypes();
        });

        loadTables();
        loadTableTypes();
        loadDishes();
      });
    }

    function disconnect() {
      if (stompClient) stompClient.disconnect();
      console.log("âŒ Ngáº¯t káº¿t ná»‘i");
    }

    async function loadTables() {
      const res = await fetch(`${BASE_URL}/tables`);
      const response = await res.json();
      tables = response.data || [];
      renderTables();
    }


    async function loadTableTypes() {
      const res = await fetch(`${BASE_URL}/tables/type`);
      const response = await res.json();
      tableTypes = response.data || [];
      renderTableTypes();
    }

    async function loadDishes() {
      const res = await fetch(`${BASE_URL}/dishes`);
      const response = await res.json();
      const dishes = response.data || [];
      renderDishes(dishes);
    }

    async function addTable() {
      const name = document.getElementById("tableName").value;
      const typeId = document.getElementById("tableTypeSelect").value;
      if (!name.trim() || !typeId) return alert("âš ï¸ Nháº­p Ä‘áº§y Ä‘á»§");

      const payload = { name, tableType: { id: typeId } };
      const res = await fetch(`${BASE_URL}/tables`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const response = await res.json();
      alert(response.message || "âœ… ÄÃ£ thÃªm bÃ n");
    }

    async function addTableType() {
      const name = document.getElementById("tableTypeName").value;
      if (!name.trim()) return alert("âš ï¸ Nháº­p tÃªn loáº¡i bÃ n");

      const payload = { name };
      const res = await fetch(`${BASE_URL}/tables/type`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const response = await res.json();
      alert(response.message || "âœ… ÄÃ£ thÃªm loáº¡i bÃ n");
    }

    async function deleteTable(id) {
      if (!confirm("XÃ³a bÃ n nÃ y?")) return;
      const res = await fetch(`${BASE_URL}/tables/${id}`, { method: "DELETE" });
      const response = await res.json();
      alert(response.message || "âœ… ÄÃ£ xÃ³a bÃ n");
    }

    async function deleteTableType(id) {
      if (!confirm("XÃ³a loáº¡i bÃ n nÃ y?")) return;
      const res = await fetch(`${BASE_URL}/tables/type/${id}`, { method: "DELETE" });
      const response = await res.json();
      alert(response.message || "âœ… ÄÃ£ xÃ³a loáº¡i bÃ n");
    }

    function renderTables() {
      const list = document.getElementById("tableList");
      list.innerHTML = "";
      tables.forEach(table => {
        list.innerHTML += `
          <li>
            ğŸª‘ <strong>${table.name}</strong> | ID: ${table.id}
            <button onclick="deleteTable('${table.id}')">ğŸ—‘ï¸ XÃ³a</button>
          </li>
        `;
      });
    }

    function renderTableTypes() {
      const list = document.getElementById("tableTypeList");
      list.innerHTML = "";
      const select = document.getElementById("tableTypeSelect");
      select.innerHTML = `<option disabled selected>-- Chá»n loáº¡i bÃ n --</option>`;

      tableTypes.forEach(type => {
        list.innerHTML += `
          <li>ğŸ“¦ ${type.name}
            <button onclick="deleteTableType('${type.id}')">ğŸ—‘ï¸ XÃ³a</button>
          </li>
        `;
        select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
      });
    }

    function renderDishes(dishes) {
      const list = document.getElementById("dishList");
      list.innerHTML = "";
      dishes.forEach(dish => {
        list.innerHTML += `
          <li>
            ğŸ´ <strong>${dish.name}</strong> - ${dish.price}Ä‘/${dish.unit}
            <input type="text" placeholder="ID bÃ n" id="add-${dish.id}" />
            <button onclick="addDishToTable('${dish.id}')">â• ThÃªm</button>
          </li>
        `;
      });
    }

    async function addDishToTable(dishId) {
      const input = document.getElementById("add-" + dishId);
      const tableId = input.value.trim();
      if (!tableId) return alert("âš ï¸ Nháº­p ID bÃ n");

      const payload = {
        dishId,
        tableId,
        quanlity: 1,
        note: ""
      };

      const res = await fetch(`${BASE_URL}/order/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const response = await res.json();
      alert(response.message || "âœ… ÄÃ£ thÃªm mÃ³n vÃ o bÃ n");
    }

    function loadOrderItems() {
      const tableId = document.getElementById("selectedTableId").value.trim();
      if (!tableId) return alert("âš ï¸ Nháº­p ID bÃ n");

      // âœ… Gá»i subscribe socket theo bÃ n
      subscribeToTable(tableId);

      fetch(`${BASE_URL}/order/items/${tableId}`)
        .then(res => res.json())
        .then(response => {
          renderOrderItems(response.data || [], tableId);
        });
    }
    function renderOrderItems(items, tableId) {
      orderItems = items; // ğŸ’¾ LÆ°u vÃ o biáº¿n toÃ n cá»¥c

      const list = document.getElementById("orderItemList");
      list.innerHTML = "";

      if (items.length === 0) {
        list.innerHTML = "<li>ğŸš« KhÃ´ng cÃ³ mÃ³n nÃ o trong bÃ n nÃ y.</li>";
        return;
      }

      items.forEach(item => {
        list.innerHTML += `
          <li data-item-id="${item.id}">
            ğŸ½ï¸ <strong>${item.dishName}</strong> -
            <span class="item-quantity">${item.quantity}</span> ${item.unit}
            <br/>
            ğŸ’¬ Ghi chÃº: ${item.note || "KhÃ´ng"}
            <button onclick="updateQuantityOnUI('${item.id}', 1)">â•</button>
            <button onclick="updateQuantityOnUI('${item.id}', -1)">â–</button>
          </li>
        `;
      });
    }

     function subscribeToTable(tableId) {
      if (!stompClient) return;

      stompClient.subscribe(`/topic/tables/${tableId}/orderitem-added`, message => {
        const item = JSON.parse(message.body);
        console.log("ğŸ“¡ MÃ³n thÃªm qua socket:", item);
        loadOrderItems(); // chá»‰ gá»i á»Ÿ Ä‘Ã¢y â€” khÃ´ng cáº§n gá»i láº¡i sau patch ná»¯a
      });


      stompClient.subscribe(`/topic/tables/${tableId}/orderitem-updatequantity`, message => {
        const item = JSON.parse(message.body);
        const { id, quantity } = item;
        updateQuantityOnUI(id, quantity); // cáº­p nháº­t hiá»ƒn thá»‹ mÃ  khÃ´ng cáº§n gá»i láº¡i API
      });

      // ğŸ—‘ï¸ Khi xoÃ¡ mÃ³n khá»i bÃ n
      stompClient.subscribe(`/topic/tables/${tableId}/orderitem`, message => {
        const item = JSON.parse(message.body);
        console.log("ğŸ—‘ï¸ MÃ³n Ä‘Ã£ xoÃ¡:", item);
        loadOrderItems(); // hiá»ƒn thá»‹ láº¡i danh sÃ¡ch mÃ³n
      });
    }


    function updateQuantityOnUI(id, quantity) {
      const list = document.getElementById("orderItemList");
      const items = list.querySelectorAll("li");
console.log("ğŸ”„ Updating:", id, "->", quantity);
      items.forEach(li => {
        const itemId = li.getAttribute("data-item-id");
        if (itemId === id) {
          const quantityElement = li.querySelector(".item-quantity");
          if (quantityElement) {
            quantityElement.textContent = quantity;
          }
          if (quantity <= 0) {
            li.remove();
          }
        }
      });

      // ğŸ”§ Cáº­p nháº­t láº¡i giÃ¡ trá»‹ trong biáº¿n orderItems
      const item = orderItems.find(i => i.id === id);
      if (item) item.quantity = quantity;
    }

</script>